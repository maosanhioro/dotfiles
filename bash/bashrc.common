# 共通 bash 設定（WSL/Ubuntu Desktop 共通）

# 対話シェル以外は何もしない
case $- in
  *i*) ;;
  *) [ -n "${TA_FORCE:-}" ] || return ;;
esac

# ローカル bin（AppImage / 手動インストール）
case ":$PATH:" in
  *":$HOME/.local/bin:"*) ;;
  *) export PATH="$HOME/.local/bin:$PATH" ;;
esac

############################################
# 履歴
############################################
HISTCONTROL=ignoreboth
shopt -s histappend
shopt -s checkwinsize

# ここは好みで増やしてOK（あなたの元設定に近い値）
HISTSIZE=50000
HISTFILESIZE=100000

# プロンプト表示のたびに履歴を即時反映
__prompt_cmd() { :; }
PROMPT_COMMAND="__prompt_cmd; history -a"

############################################
# lesspipe
############################################
[ -x /usr/bin/lesspipe ] && eval "$(SHELL=/bin/sh lesspipe)"

############################################
# プロンプト（共通。WSL/Ubuntu でホスト名だけ変えるなら env別で上書き可）
############################################
case "$TERM" in
  xterm-color|*-256color|xterm*|rxvt*) color_prompt=yes;;
esac

if [ "${color_prompt:-}" = yes ]; then
  PS1='\[\033[32m\]\u@\[\033[36m\]\h\[\033[0m\]:\[\033[33m\]\W\[\033[0m\]$ '
else
  PS1='\u@\h:\w\$ '
fi
unset color_prompt

############################################
# 便利系
############################################
if command -v eza >/dev/null 2>&1; then
  alias ls='eza --group-directories-first --icons=never'
  alias ll='eza -alF --group-directories-first --icons=never'
  alias la='eza -a --group-directories-first --icons=never'
  alias l='eza -F --group-directories-first --icons=never'
else
  alias ll='ls -alF'
  alias la='ls -A'
  alias l='ls -CF'
fi
alias ..='cd ..'
alias ...='cd ../..'
alias cls='clear'

# エディタ
if command -v nvim >/dev/null 2>&1; then
  export EDITOR="nvim"
  export VISUAL="nvim"
fi

# ツール系ヘルパー
path() { printf '%s\n' "${PATH}" | tr ':' '\n'; }
mkcd() { mkdir -p "$1" && cd "$1"; }
extract() {
  if [ -f "$1" ]; then
    case "$1" in
      *.tar.bz2) tar xjf "$1" ;;
      *.tar.gz) tar xzf "$1" ;;
      *.tar.xz) tar xJf "$1" ;;
      *.tar) tar xf "$1" ;;
      *.bz2) bunzip2 "$1" ;;
      *.gz) gunzip "$1" ;;
      *.xz) unxz "$1" ;;
      *.zip) unzip "$1" ;;
      *) echo "extract: unsupported file: $1" ;;
    esac
  else
    echo "extract: file not found: $1"
  fi
}

# Git ヘルパー
alias g='git'
alias gst='git status -sb'
alias gco='git checkout'
alias gcb='git checkout -b'
alias gl='git log --oneline --graph --decorate'
alias gpl='git pull --ff-only'
alias gps='git push'
alias gpf='git push --force-with-lease'
alias gaa='git add -A'
alias gcm='git commit -m'
cproj() {
  local root
  root="$(git rev-parse --show-toplevel 2>/dev/null)" || return 1
  cd "${root}" || return 1
}

# fzf ヘルパー（任意）
if command -v fzf >/dev/null 2>&1; then
  ff() {
    local file
    file="$(fzf --height=40% --reverse --border --preview 'bat --style=numbers --color=always {} 2>/dev/null || sed -n "1,200p" {}')" || return
    [ -n "${file}" ] && ${EDITOR:-nvim} "${file}"
  }
  fcd() {
    local dir
    if command -v fd >/dev/null 2>&1; then
      dir="$(fd --type d --hidden --exclude .git 2>/dev/null | fzf --height=40% --reverse --border)" || return
    else
      dir="$(find . -type d -name .git -prune -o -type d -print 2>/dev/null | fzf --height=40% --reverse --border)" || return
    fi
    [ -n "${dir}" ] && cd "${dir}"
  }
fi

############################################
# NVM（即時ロード：遅延なし）
############################################
export NVM_DIR="$HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
fi
if [ -s "$NVM_DIR/bash_completion" ]; then
  . "$NVM_DIR/bash_completion"
fi

############################################
# tmux：AI アシスト作業セッション（共通ロジック）
############################################
ta() {
  local S="ai-assist"
  local W="ws"
  local TA_DEBUG="${TA_DEBUG:-}"
  local TA_INTERNAL="${TA_INTERNAL:-}"
  local TA_CWD="${TA_CWD:-$PWD}"
  local TA_COLS TA_LINES

  command -v tmux >/dev/null 2>&1 || { echo "tmux not found"; return 1; }

  _ta_dbg() {
    [ -n "${TA_DEBUG}" ] && printf '[ta] %s\n' "$*" >&2
  }

  _ta_run() {
    if [ -n "${TA_DEBUG}" ]; then
      printf '[ta] $ %s\n' "$*" >&2
    fi
    "$@"
  }

  _ta_dims() {
    if [ -n "${TMUX}" ] && command -v tmux >/dev/null 2>&1; then
      TA_COLS="$(tmux display-message -p -t "${TMUX_PANE}" '#{client_width}' 2>/dev/null)"
      TA_LINES="$(tmux display-message -p -t "${TMUX_PANE}" '#{client_height}' 2>/dev/null)"
    else
      TA_COLS="$(tput cols 2>/dev/null)"
      TA_LINES="$(tput lines 2>/dev/null)"
    fi
    case "${TA_COLS}" in ''|*[!0-9]*) TA_COLS=120;; esac
    case "${TA_LINES}" in ''|*[!0-9]*) TA_LINES=40;; esac
    _ta_dbg "dims=${TA_COLS}x${TA_LINES}"
  }

  _ta_build_layout() {
    local s="$1" w="$2"
    # Kill and create a fresh window for the layout
    _ta_run tmux kill-window -t "${s}:${w}" 2>/dev/null || true
    _ta_run tmux new-window -t "${s}" -n "${w}" -d -c "${TA_CWD}"

    local target="${s}:${w}"
    local root_pane
    _ta_dbg "$ tmux list-panes -t ${target} -F #{pane_id}"
    root_pane="$(tmux list-panes -t "${target}" -F '#{pane_id}' | head -n 1)"
    [ -n "${root_pane}" ] || { echo "ta: failed to create window"; return 1; }
    _ta_dbg "root_pane=${root_pane}"

    # Create 4 columns using absolute sizes (compatible with older tmux).
    local total_cols total_lines col right_w mid_w left_w
    total_cols="$(tmux display-message -p -t "${target}" '#{window_width}' 2>/dev/null)"
    total_lines="$(tmux display-message -p -t "${target}" '#{window_height}' 2>/dev/null)"
    case "${total_cols}" in ''|*[!0-9]*) total_cols="${TA_COLS}";; esac
    case "${total_lines}" in ''|*[!0-9]*) total_lines="${TA_LINES}";; esac
    col=$(( total_cols / 4 ))
    right_w="${col}"
    mid_w="${col}"
    left_w="${col}"
    [ "${right_w}" -lt 1 ] && right_w=1
    [ "${mid_w}" -lt 1 ] && mid_w=1
    [ "${left_w}" -lt 1 ] && left_w=1

    # Split into 4 columns (rightmost first, then middle-right, then middle-left).
    _ta_run tmux split-window -h -l "${right_w}" -t "${root_pane}"
    _ta_run tmux split-window -h -l "${mid_w}" -t "${root_pane}"
    _ta_run tmux split-window -h -l "${left_w}" -t "${root_pane}"

    # Resolve panes left -> right by coordinates, then split each column.
    local panes a b c d
    _ta_dbg "$ tmux list-panes -t ${target} -F '#{pane_id} #{pane_left}'"
    panes="$(tmux list-panes -t "${target}" -F '#{pane_id} #{pane_left}' | sort -n -k2 | awk '{print $1}')"
    a="$(printf '%s\n' "${panes}" | sed -n '1p')"
    b="$(printf '%s\n' "${panes}" | sed -n '2p')"
    c="$(printf '%s\n' "${panes}" | sed -n '3p')"
    d="$(printf '%s\n' "${panes}" | sed -n '4p')"
    _ta_dbg "panes=${panes}"

    # Split only the left column vertically (50/50). Others stay single.
    _ta_split_v_pct() {
      local pane="$1" bottom_pct="$2"
      local h bottom
      h="$(tmux display-message -p -t "${pane}" '#{pane_height}' 2>/dev/null)"
      case "${h}" in ''|*[!0-9]*) h="${total_lines}";; esac
      bottom=$(( h * bottom_pct / 100 ))
      [ "${bottom}" -lt 1 ] && bottom=1
      [ "${bottom}" -ge "${h}" ] && bottom=$(( h / 2 ))
      _ta_run tmux split-window -v -l "${bottom}" -t "${pane}"
    }

    [ -n "${a}" ] && _ta_split_v_pct "${a}" 50

    # Enforce exact ratio for the left column (some tmux versions ignore -l precisely).
    _ta_resize_column() {
      local left_x="$1" bottom_pct="$2"
      local rows total bottom top_pane bottom_pane cur delta
      rows="$(tmux list-panes -t "${target}" -F '#{pane_id} #{pane_left} #{pane_top} #{pane_height}' \
        | awk -v x="${left_x}" '$2==x {print $0}' | sort -n -k3)"
      top_pane="$(printf '%s\n' "${rows}" | sed -n '1p' | awk '{print $1}')"
      bottom_pane="$(printf '%s\n' "${rows}" | sed -n '2p' | awk '{print $1}')"
      [ -n "${top_pane}" ] || return
      [ -n "${bottom_pane}" ] || return
      total="$(printf '%s\n' "${rows}" | awk '{sum+=$4} END {print sum}')"
      case "${total}" in ''|*[!0-9]*) return;; esac
      bottom=$(( total * bottom_pct / 100 ))
      [ "${bottom}" -lt 1 ] && bottom=1
      [ "${bottom}" -ge "${total}" ] && bottom=$(( total / 2 ))
      cur="$(tmux display-message -p -t "${bottom_pane}" '#{pane_height}' 2>/dev/null)"
      case "${cur}" in ''|*[!0-9]*) return;; esac
      delta=$(( cur - bottom ))
      if [ "${delta}" -gt 0 ]; then
        _ta_run tmux resize-pane -U "${delta}" -t "${bottom_pane}"
      elif [ "${delta}" -lt 0 ]; then
        _ta_run tmux resize-pane -D "$(( -delta ))" -t "${bottom_pane}"
      fi
    }

    # Left column is 50/50.
    [ -n "${a}" ] && _ta_resize_column "$(tmux display-message -p -t "${a}" '#{pane_left}' 2>/dev/null)" 50

    # Identify panes by column and launch apps.
    local rows lefts left1 left2 left3 left4 A A2 B C D
    rows="$(tmux list-panes -t "${target}" -F '#{pane_id} #{pane_left} #{pane_top}')"
    lefts="$(printf '%s\n' "${rows}" | awk '{print $2}' | sort -n | uniq)"
    left1="$(printf '%s\n' "${lefts}" | sed -n '1p')"
    left2="$(printf '%s\n' "${lefts}" | sed -n '2p')"
    left3="$(printf '%s\n' "${lefts}" | sed -n '3p')"
    left4="$(printf '%s\n' "${lefts}" | sed -n '4p')"
    A="$(printf '%s\n' "${rows}" | awk -v x="${left1}" '$2==x {print $0}' | sort -n -k3 | sed -n '1p' | awk '{print $1}')"
    A2="$(printf '%s\n' "${rows}" | awk -v x="${left1}" '$2==x {print $0}' | sort -n -k3 | sed -n '2p' | awk '{print $1}')"
    B="$(printf '%s\n' "${rows}" | awk -v x="${left2}" '$2==x {print $0}' | sort -n -k3 | sed -n '1p' | awk '{print $1}')"
    C="$(printf '%s\n' "${rows}" | awk -v x="${left3}" '$2==x {print $0}' | sort -n -k3 | sed -n '1p' | awk '{print $1}')"
    D="$(printf '%s\n' "${rows}" | awk -v x="${left4}" '$2==x {print $0}' | sort -n -k3 | sed -n '1p' | awk '{print $1}')"

    _ta_send_cmd() {
      local pane="$1" cmd="$2"
      [ -n "${pane}" ] && [ -n "${cmd}" ] && _ta_run tmux send-keys -t "${pane}" "${cmd}" C-m
    }
    _ta_set_title() {
      local pane="$1" title="$2"
      [ -n "${pane}" ] && [ -n "${title}" ] && _ta_run tmux select-pane -t "${pane}" -T "${title}"
    }
    _ta_send_cmd "${A2}" "nvim"
    _ta_send_cmd "${B}" "codex"
    _ta_send_cmd "${C}" "claude"
    _ta_send_cmd "${D}" "gemini"
    _ta_set_title "${A}" "shell"
    _ta_set_title "${A2}" "nvim"
    _ta_set_title "${B}" "codex"
    _ta_set_title "${C}" "claude"
    _ta_set_title "${D}" "gemini"

    # Select top-left pane
    [ -n "${a}" ] && _ta_run tmux select-pane -t "${a}"
  }

  _ta_dims
  if [ -z "${TMUX}" ] && [ -z "${TA_INTERNAL}" ]; then
    if ! tmux has-session -t "${S}" 2>/dev/null; then
      _ta_run tmux new-session -d -s "${S}" -n "main" -c "${TA_CWD}"
    fi
    local ta_cwd_q
    ta_cwd_q="$(printf %q "${TA_CWD}")"
    _ta_run tmux run-shell -t "${S}" "TA_CWD=${ta_cwd_q} bash -lc 'TA_FORCE=1; . ~/.bashrc; TA_INTERNAL=1 ta'"
    _ta_run tmux attach-session -t "${S}"
    return
  fi

  if ! tmux has-session -t "${S}" 2>/dev/null; then
    _ta_run tmux new-session -d -s "${S}" -n "main" -c "${TA_CWD}" # Start with a main window
    _ta_build_layout "${S}" "${W}"
  else
    # Check if window 'ws' exists. If not, create it.
    if ! tmux list-windows -t "${S}" -F '#{window_name}' 2>/dev/null | grep -qx "${W}"; then
      _ta_build_layout "${S}" "${W}"
    else
      # If it exists, check the pane count. Recreate if it's not our layout.
      local pane_count
      pane_count="$(tmux list-panes -t "${S}:${W}" 2>/dev/null | wc -l | tr -d ' ')"
      if [ -z "${pane_count}" ] || [ "${pane_count}" -ne 4 ]; then
        _ta_build_layout "${S}" "${W}"
      fi
    fi
  fi

  # Select the target window before attaching/switching
  _ta_run tmux select-window -t "${S}:${W}"

  if [ -n "${TMUX}" ]; then
    _ta_run tmux switch-client -t "${S}"
  fi
}

tl() { tmux ls; }
tk() { tmux kill-session -t ai-assist 2>/dev/null || true; }
treset() { tmux kill-server 2>/dev/null || true; }
tmr() { tmux source-file ~/.tmux.conf 2>/dev/null || true; }

############################################
# SSH 接続時の自動 tmux 接続（共通）
############################################
if [ -n "$SSH_CONNECTION" ] && [ -z "$TMUX" ] && command -v tmux >/dev/null 2>&1; then
  ta
fi
